name: Build Ping Server Firmware

permissions:
  contents: write

on:
  push:
    # Pattern matched against refs/tags
    tags:        
      - '*'           # Push events to every tag not containing /

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      # Tag-Name des Push-Events (z.B. "ping-server-1.2.3")
      GIT_TAG_VERSION: ${{ github.ref_name }}

    steps:
      - name: Checkout at tag
        uses: actions/checkout@v4
        with:
          # Der ausl√∂sende Ref inkl. "refs/tags/..."
          ref: ${{ github.ref }}

      - name: Setup Build Environment
        uses: ./.github/actions/setup-build-environment

      - name: Build Firmwares
        env:
          FIRMWARE_VERSION: ${{ env.GIT_TAG_VERSION }}
        run: /usr/bin/env bash build.sh build-ping-server-firmwares

      - name: Upload Workflow Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ping-server-firmwares
          path: out

      - name: Create or update GitHub Release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Ping Server Firmware ${{ github.ref_name }}
          files: out/*
